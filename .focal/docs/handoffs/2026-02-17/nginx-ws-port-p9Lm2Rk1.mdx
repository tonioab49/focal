# Goal

- Introduce Nginx in the production container to front both Next.js and Hocuspocus.
- Serve HTTP app traffic and websocket collaboration traffic on one external port, with websocket path `/ws`.
- Make external listen port configurable via runtime env var `PORT`.

# Context / assumptions

- Initial container state ran Next and Hocuspocus directly as two Node processes without a reverse proxy.
- Collaboration client previously targeted `ws(s)://<host>:1236`, so path-based ws routing required client URL updates.
- Current local dev flow (`yarn dev`) still runs Next + Hocuspocus directly, without Nginx.
- Container runs as non-root `nextjs`; Nginx writable runtime dirs are required.
- `EXPOSE` is metadata only and does not control runtime binding.
- UNKNOWN: whether deployment environment injects `PORT` automatically (PaaS behavior).
- UNKNOWN: where TLS terminates (upstream LB/proxy vs container).

# Decisions made

- Added Nginx to runner image and kept Next/Hocuspocus as internal upstream services.
- Added process supervisor script `docker/start.js` to launch and coordinate Next, Hocuspocus, and Nginx.
- Added graceful shutdown handling for SIGINT/SIGTERM and cascading child-exit behavior.
- Configured Nginx routing:
- `location /` proxies to Next upstream.
- `location /ws` proxies to Hocuspocus upstream with websocket upgrade headers.
- Added websocket-friendly timeouts (`proxy_read_timeout`, `proxy_send_timeout`).
- Removed dual external port model for websocket passthrough; external traffic is now single-port + path-based.
- Updated client ws URL resolution in `src/hooks/useCollaboration.ts`:
- in development fallback to direct `ws://<hostname>:1236`.
- in non-dev default to `ws(s)://<current-host>/ws`.
- Separated external and internal port responsibilities:
- `PORT` is now external Nginx listen port (default `4000`).
- `NEXT_INTERNAL_PORT` is Next internal port (default `3000`).
- `HOCUSPOCUS_PORT` remains Hocuspocus internal port (default `1236`).
- Replaced static Nginx config with template rendering at startup:
- `docker/nginx/default.conf.template` contains placeholders replaced by `docker/start.js` before Nginx starts.
- Updated docker helper script in `package.json` to publish and pass `PORT` dynamically.

# Artifacts

- Modified: `Dockerfile`
- Added: `docker/start.js`
- Added/renamed: `docker/nginx/default.conf.template` (replacing `docker/nginx/default.conf`)
- Modified: `src/hooks/useCollaboration.ts`
- Modified: `package.json`
- Minimal diff summary:
- install/configure Nginx for non-root runtime.
- route HTTP to Next and websocket path `/ws` to Hocuspocus.
- remove external `1236` exposure and switch to single external port.
- make external port runtime-configurable through `PORT`.
- render Nginx config from template at container startup.

# If we resume

- Build and run with default and custom ports (`PORT=8080`) and verify `http://localhost:<PORT>` + `ws://localhost:<PORT>/ws`.
- Confirm websocket handshake returns `101 Switching Protocols` on `/ws`.
- Inspect rendered config in container at `/etc/nginx/http.d/default.conf` for correct substitution.
- Optionally add startup validation in `docker/start.js` for numeric, non-empty port vars.
- Optionally document production env contract (`PORT`, `NEXT_INTERNAL_PORT`, `HOCUSPOCUS_PORT`).
